name: "Database Docker Image (feature-branch)"

permissions:
  contents: read
  packages: write

on:
  push:
    branches-ignore:
      - main
      - canary

jobs:
  schema-modified:
    runs-on: ubuntu-latest
    name: "Check for Database Schema Update"
    outputs:
      db_changed: ${{ steps.changed.outputs.changed }}

    steps:
      - name: Checkout with tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Schema Changes
        id: changed
        uses: ./.github/actions/file-change
        with:
          base_commit: ${{ github.event.before }}
          newest_commit: ${{ github.sha }}
          regex_pattern: "drizzle/*/schema.ts"

  build-db-image:
    runs-on: ubuntu-latest
    name: "Build new Database Docker Image"
    needs: [schema-modified]

    steps:
      - name: Checkout with tags
        if: needs.schema-modified.outputs.db_changed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Stop if not changed
        if: needs.schema-modified.outputs.db_changed == 'false'
        run: echo "init.sql not changed since previous release â€” skipping image build."

      - name: Set up QEMU
        if: needs.schema-modified.outputs.db_changed == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Log in to GHCR
        if: needs.schema-modified.outputs.db_changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        if: needs.schema-modified.outputs.db_changed == 'true'
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          platforms: linux/amd64,linux/arm64

      - name: Compute Dynamic Image Tag
        if: needs.schema-modified.outputs.db_changed == 'true'
        id: tags
        uses: ./.github/actions/compute-db-image-tags
        with:
          branch: ${{ github.ref_name }}

      - name: Show resolved tags (debug)
        if: needs.schema-modified.outputs.db_changed == 'true'
        shell: bash
        run: |
          echo "Tags to apply for ${{github.ref_name}}:"
          echo "Image:  ${{ steps.tags.outputs.image_name }}"

          WARNING="${{ steps.tags.outputs.warning }}"
          if [ -n "$WARNING" ]; then
            echo "::warning::${WARNING}"
          fi

          echo "${{ steps.tags.outputs.tags }}"

      # -------- build using whichever tag set exists --------
      - name: Build and Push Multi-Platform Image
        if: needs.schema-modified.outputs.db_changed == 'true'
        run: |
          set -euo pipefail

          # Collect the newline-separated tags from whichever step ran
          TAGS_COMBINED="${{ steps.tags.outputs.tags }}"

          # Turn them into an array safely (preserve spaces, handle newlines)
          mapfile -t TAGS < <(printf '%s\n' "$TAGS_COMBINED" | sed '/^$/d')

          if [ ${#TAGS[@]} -eq 0 ]; then
            echo "No tags were produced by the compute-tag steps."
            exit 1
          fi

          echo "Tags to apply:"
          printf '  %s\n' "${TAGS[@]}"

          # Build list of -t args
          TAG_ARGS=()
          for t in "${TAGS[@]}"; do
            TAG_ARGS+=( -t "$t" )
          done

          # Build & push
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            "${TAG_ARGS[@]}" \
            ./database
