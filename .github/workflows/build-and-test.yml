name: Build and Test

on: push

permissions:
  packages: read

env:
  BETTER_AUTH_URL: ${{ vars.BETTER_AUTH_URL }}
  NEXT_PUBLIC_BASE_URL: ${{ vars.NEXT_PUBLIC_BASE_URL }}
  AUTH_SECRET: ${{ secrets.AUTH_SECRET }}

  DATABASE_HOST: ${{ vars.DATABASE_HOST}}
  DATABASE_PORT: ${{ vars.DATABASE_PORT }}
  DATABASE_NAME: ${{ vars.DATABASE_NAME }}
  DATABASE_USER: ${{ vars.DATABASE_USER }}
  DATABASE_PASSWORD: 123

  AUTH_GITHUB_ID: ${{ secrets.AUTH_GITHUB_ID}}
  AUTH_GITHUB_SECRET: ${{ secrets.AUTH_GITHUB_SECRET }}

  AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
  AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}

  NEXT_PUBLIC_MODE: ${{ vars.NEXT_PUBLIC_MODE }}
  DEX_PROVIDER_URL: ${{ vars.DEX_PROVIDER_URL }}
  DEX_CLIENT_ID: ${{ secrets.DEX_CLIENT_ID}}
  DEX_CLIENT_SECRET: ${{secrets.DEX_CLIENT_SECRET}}

  NODE_VERSION: 24.11.1

jobs:
  check-file-changes:
    name: Check for Relevant File Changes
    runs-on: ubuntu-latest
    outputs:
      relevant: ${{ steps.check.outputs.relevant }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check for relevant changes
        id: check
        uses: ./.github/actions/check-changed-files
        with:
          base: ${{ github.event.before }}
          disable-workflow-skips: ${{ secrets.DISABLE_WORKFLOW_SKIPS }}

  run-component-tests:
    name: Run Component Tests
    needs: [check-file-changes]
    runs-on: ubuntu-latest

    services:
      mysql:
        image: ghcr.io/master-thesis-188199/knowledgecheckr-database:latest
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_HOST: "%"
          MYSQL_ROOT_PASSWORD: ${{ env.DATABASE_PASSWORD }}
          MYSQL_DATABASE: ${{ env.DATABASE_NAME }}
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      dex:
        image: ghcr.io/master-thesis-188199/knowledgecheckr-dex:latest
        ports: [5556:5556]
        options: >-
          --health-cmd="wget -qO- http://localhost:5556/dex/.well-known/openid-configuration || exit 1"
          --health-interval=5s --health-timeout=3s --health-retries=30

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Dependencies
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: ./.github/actions/caching-dependencies
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run Instrumented Build-Script
        if: needs.check-file-changes.outputs.relevant == 'true'
        run: pnpm build:instrumented

      - name: Run Cypress Tests
        if: needs.check-file-changes.outputs.relevant == 'true'
        run: pnpm start & npx wait-on --timeout 120000 ${{ env.NEXT_PUBLIC_BASE_URL }} && pnpm test:component

      - name: Upload Coverage to Codecov
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: Master-Thesis-188199/KnowledgeCheckr
          files: /coverage/**/lcov.info
          fail_ci_if_error: true
          verbose: true

      - name: Upload Coverage to Codecov
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: Master-Thesis-188199/KnowledgeCheckr
          files: /coverage/**/lcov.info
          fail_ci_if_error: true
          verbose: true

  run-jest-tests:
    name: Run Jest Tests
    needs: [check-file-changes]
    runs-on: ubuntu-latest

    services:
      mysql:
        image: ghcr.io/master-thesis-188199/knowledgecheckr-database:latest
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_HOST: "%"
          MYSQL_ROOT_PASSWORD: ${{ env.DATABASE_PASSWORD }}
          MYSQL_DATABASE: ${{ env.DATABASE_NAME }}
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Dependencies
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: ./.github/actions/caching-dependencies
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run Jest Tests
        if: needs.check-file-changes.outputs.relevant == 'true'
        run: pnpm jest

  build:
    name: Production Build
    runs-on: ubuntu-latest
    needs: check-file-changes

    services:
      mysql:
        image: ghcr.io/master-thesis-188199/knowledgecheckr-database:latest
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_HOST: "%"
          MYSQL_ROOT_PASSWORD: ${{ env.DATABASE_PASSWORD }}
          MYSQL_DATABASE: ${{ env.DATABASE_NAME }}
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Skip Build when nothing changed
        if: needs.check-file-changes.outputs.relevant == 'false'
        run: echo "Skipping build execution because no relevant files were modified by the last commit / pushed commits"

      - name: Setup Dependencies
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: ./.github/actions/caching-dependencies
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run Build-Script
        if: needs.check-file-changes.outputs.relevant == 'true'
        run: pnpm build

  setup:
    name: Setup Test Chunks
    runs-on: ubuntu-latest

    needs: check-file-changes
    outputs:
      test-chunks: ${{ steps.set-test-chunks.outputs.test-chunks }}

    steps:
      - uses: actions/checkout@v3
      - id: set-test-chunks
        name: Set Chunks
        env:
          CHUNK_SIZE: ${{ vars.TEST_CHUNK_SIZE }}
        shell: bash
        # get all spec files from the e2e directory, group them to be at most 3 at a time and transform them to json
        run: |
          echo "test-chunks=$(
            find src/tests/e2e -type f -name '*.cy.tsx' \
              | xargs -n"$CHUNK_SIZE" \
              | while read -r group; do
                  # full, comma-separated paths (for spec:)
                  paths=$(echo "$group" | tr ' ' ',')
                  # strip prefix/suffix AND swap commas for " + "
                  short=$(echo "$paths" \
                    | sed -E 's#src/tests/e2e/##g; s#\.cy\.tsx##g; s#,# + #g')
                  jq -n --arg paths "$paths" --arg short "$short" \
                    '{paths: $paths, short: $short}'
                done \
              | jq -s -c
          )" >> $GITHUB_OUTPUT

  run-e2e-tests:
    needs: [check-file-changes, setup]

    services:
      mysql:
        image: ghcr.io/master-thesis-188199/knowledgecheckr-database:latest
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_HOST: "%"
          MYSQL_ROOT_PASSWORD: ${{ env.DATABASE_PASSWORD }}
          MYSQL_DATABASE: ${{ env.DATABASE_NAME }}
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      dex:
        image: ghcr.io/master-thesis-188199/knowledgecheckr-dex:latest
        ports: [5556:5556]
        options: >-
          --health-cmd="wget -qO- http://localhost:5556/dex/.well-known/openid-configuration || exit 1"
          --health-interval=5s --health-timeout=3s --health-retries=30

    name: "E2E Tests: ${{ matrix.chunk.short }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        chunk: ${{ fromJson(needs.setup.outputs['test-chunks']) }}

    timeout-minutes: 15
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3

      - name: Setup Dependencies
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: ./.github/actions/caching-dependencies
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create Cypress Environment File
        if: needs.check-file-changes.outputs.relevant == 'true'
        run: |
          echo '{  
            "GOOGLE_USERNAME": "${{ secrets.TEST_GOOGLE_USERNAME }}",  
            "GOOGLE_PASSWORD": "${{ secrets.TEST_GOOGLE_PASSWORD }}",  
            "NEXT_PUBLIC_BASE_URL": "${{ env.NEXT_PUBLIC_BASE_URL }}", 
            "SkipOnCi": true 
          }' > cypress.env.json

      - name: Run Instrumented Build-Script
        if: needs.check-file-changes.outputs.relevant == 'true'
        run: pnpm build:instrumented

      - name: Cypress run ðŸ§ª
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: cypress-io/github-action@v3
        with:
          start: pnpm start
          wait-on: "npx wait-on --timeout 120000 ${{ env.NEXT_PUBLIC_BASE_URL }}"
          wait-on-timeout: 120

          browser: chrome
          install: false
          spec: ${{ matrix.chunk.paths }}

      - name: Upload Coverage to Codecov
        if: needs.check-file-changes.outputs.relevant == 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: Master-Thesis-188199/KnowledgeCheckr
          files: /coverage/**/lcov.info
          fail_ci_if_error: true
          verbose: true

  e2e-test-summary:
    name: E2E Tests Summary
    runs-on: ubuntu-latest
    needs: run-e2e-tests
    if: ${{ always() }}
    steps:
      - name: Fail if any matrix job failed
        if: ${{ needs.run-e2e-tests.result != 'success' }}
        run: |
          echo "At least one e2e test-suite was unsuccessful!"
          exit 1

      - name: All good
        if: ${{ needs.run-e2e-tests.result == 'success' }}
        run: echo "All e2e tests passed ðŸŽ‰"

  Skip-Executions:
    name: Skip Build And Test
    needs: check-file-changes
    if: needs.check-file-changes.outputs.relevant == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Skip Build And Test
        run: echo "Skipping build and test execution because no relevant files were modified by the last commit / pushed commits"
